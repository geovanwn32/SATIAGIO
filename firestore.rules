rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Funções Auxiliares
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verifica se o usuário é dono do documento (pelo campo userId)
    function isOwner() {
      return isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Verifica se o usuário está criando um documento para si mesmo
    function isCreatingOwn() {
      return isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    // Regra Padrão: Bloquear tudo que não for explicitamente permitido
    match /{document=**} {
      allow read, write: if false; 
    }

    // ---------------------------------------------------------
    // Módulos Solicitados (Vendas, Compras, Estoque)
    // ---------------------------------------------------------

    // Vendas (Sales)
    match /sales/{saleId} {
      allow read, update, delete: if isOwner();
      allow create: if isCreatingOwn();
    }

    // Compras (Purchases)
    match /purchases/{purchaseId} {
      allow read, update, delete: if isOwner();
      allow create: if isCreatingOwn();
    }

    // Estoque (Products)
    match /products/{productId} {
      allow read, update, delete: if isOwner();
      allow create: if isCreatingOwn();
    }

    // ---------------------------------------------------------
    // Outros Módulos do Sistema (Necessários para o App funcionar)
    // ---------------------------------------------------------

    // Clientes
    match /clients/{clientId} {
      allow read, update, delete: if isOwner();
      allow create: if isCreatingOwn();
    }

    // Orçamentos (Quotes)
    match /quotes/{quoteId} {
      allow read, update, delete: if isOwner();
      allow create: if isCreatingOwn();
    }

    // Serviços
    match /services/{serviceId} {
      allow read, update, delete: if isOwner();
      allow create: if isCreatingOwn();
    }

    // Técnicos
    match /technicians/{techId} {
      allow read, update, delete: if isOwner();
      allow create: if isCreatingOwn();
    }

    // Usuários do Sistema (Contas adicionais)
    match /users/{userId} {
      allow read, update, delete: if isOwner();
      allow create: if isCreatingOwn();
    }

    // Métodos de Pagamento
    match /paymentMethods/{methodId} {
      allow read, update, delete: if isOwner();
      allow create: if isCreatingOwn();
    }

    // Dados da Empresa (Configurações)
    match /companies/{companyId} {
      // O ID do documento é o próprio ID do usuário/empresa
      allow read, write: if isAuthenticated() && request.auth.uid == companyId;
    }
  }
}
